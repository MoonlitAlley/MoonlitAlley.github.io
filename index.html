<!DOCTYPE html>
<html lang="zh-Hans">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.1.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.14.0/css/all.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css">

<script class="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Pisces","version":"8.0.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":false,"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"},"path":"search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="MoonlitAlley">
<meta property="og:url" content="http://example.com/index.html">
<meta property="og:site_name" content="MoonlitAlley">
<meta property="og:locale">
<meta property="article:author" content="Saifei Song">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://example.com/">


<script class="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-Hans'
  };
</script>

  <title>MoonlitAlley</title>
  






  <noscript>
  <style>
  body { margin-top: 2rem; }

  .use-motion .menu-item,
  .use-motion .sidebar,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header {
    visibility: visible;
  }

  .use-motion .header,
  .use-motion .site-brand-container .toggle,
  .use-motion .footer { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle,
  .use-motion .custom-logo-image {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line {
    transform: scaleX(1);
  }

  .search-pop-overlay, .sidebar-nav { display: none; }
  .sidebar-panel { display: block; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">MoonlitAlley</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">毋意，毋必，毋固，毋我</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a>

  </li>
        <li class="menu-item menu-item-favourita">

    <a href="/favourite/" rel="section"><i class="fa fa-heart fa-fw"></i>favourita</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <section class="post-toc-wrap sidebar-panel">
      </section>
      <!--/noindex-->

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Saifei Song"
      src="/images/avatar.gif">
  <p class="site-author-name" itemprop="name">Saifei Song</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">14</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">7</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">5</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>



      </section>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner index posts-expand">
      

      
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/04/18/arc42%E6%A8%A1%E7%89%88%E7%9A%84%E5%AE%9E%E8%B7%B5%E6%80%9D%E8%80%83/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Saifei Song">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="MoonlitAlley">
    </span>

    
    
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/04/18/arc42%E6%A8%A1%E7%89%88%E7%9A%84%E5%AE%9E%E8%B7%B5%E6%80%9D%E8%80%83/" class="post-title-link" itemprop="url">arc42模版的实践思考</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2025-04-18 13:28:08 / Modified: 13:28:58" itemprop="dateCreated datePublished" datetime="2025-04-18T13:28:08+08:00">2025-04-18</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1/" itemprop="url" rel="index"><span itemprop="name">架构设计</span></a>
        </span>
    </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/2025/04/18/arc42%E6%A8%A1%E7%89%88%E7%9A%84%E5%AE%9E%E8%B7%B5%E6%80%9D%E8%80%83/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2025/04/18/arc42%E6%A8%A1%E7%89%88%E7%9A%84%E5%AE%9E%E8%B7%B5%E6%80%9D%E8%80%83/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/04/18/%E4%BB%8E%E6%95%B0%E7%BE%8E%E7%A7%91%E6%8A%80%E7%9A%84%E9%A3%8E%E6%8E%A7%E6%9E%B6%E6%9E%84%E5%87%BA%E5%8F%91%EF%BC%8C%E5%A6%82%E4%BD%95%E7%90%86%E8%A7%A3DDD%E6%80%9D%E6%83%B3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Saifei Song">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="MoonlitAlley">
    </span>

    
    
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/04/18/%E4%BB%8E%E6%95%B0%E7%BE%8E%E7%A7%91%E6%8A%80%E7%9A%84%E9%A3%8E%E6%8E%A7%E6%9E%B6%E6%9E%84%E5%87%BA%E5%8F%91%EF%BC%8C%E5%A6%82%E4%BD%95%E7%90%86%E8%A7%A3DDD%E6%80%9D%E6%83%B3/" class="post-title-link" itemprop="url">从数美科技的风控架构出发，如何理解DDD思想</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2025-04-18 13:26:59" itemprop="dateCreated datePublished" datetime="2025-04-18T13:26:59+08:00">2025-04-18</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">Edited on</span>
        <time title="Modified: 2025-04-19 21:08:14" itemprop="dateModified" datetime="2025-04-19T21:08:14+08:00">2025-04-19</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1/" itemprop="url" rel="index"><span itemprop="name">架构设计</span></a>
        </span>
    </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/2025/04/18/%E4%BB%8E%E6%95%B0%E7%BE%8E%E7%A7%91%E6%8A%80%E7%9A%84%E9%A3%8E%E6%8E%A7%E6%9E%B6%E6%9E%84%E5%87%BA%E5%8F%91%EF%BC%8C%E5%A6%82%E4%BD%95%E7%90%86%E8%A7%A3DDD%E6%80%9D%E6%83%B3/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2025/04/18/%E4%BB%8E%E6%95%B0%E7%BE%8E%E7%A7%91%E6%8A%80%E7%9A%84%E9%A3%8E%E6%8E%A7%E6%9E%B6%E6%9E%84%E5%87%BA%E5%8F%91%EF%BC%8C%E5%A6%82%E4%BD%95%E7%90%86%E8%A7%A3DDD%E6%80%9D%E6%83%B3/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>[TOC]</p>
<blockquote>
<p>第一次知道 DDD， 是在 2021 年迫切想提升自己架构设计能力时，看到了一篇 2017 年美团技术团队发布的文章:<a target="_blank" rel="noopener" href="https://tech.meituan.com/2017/12/22/ddd-in-practice.html">领域驱动设计在互联网业务开发中的实践</a>，时光转瞬，四年后的今天我对 DDD 的理解还是懵懵懂懂…</p>
</blockquote>
<h2 id="现状以及面临的问题"><a href="#现状以及面临的问题" class="headerlink" title="现状以及面临的问题"></a>现状以及面临的问题</h2><p>业务：互联网业务风控、AIGC 内容风控<br>功能：支持文本、图片、视频文件、视频流、音频文件、音频流、行为事件等多种形式的内容风控、行为风控</p>
<h3 id="经典的三层架构"><a href="#经典的三层架构" class="headerlink" title="经典的三层架构"></a>经典的三层架构</h3><p><img src="/2025/04/18/%E4%BB%8E%E6%95%B0%E7%BE%8E%E7%A7%91%E6%8A%80%E7%9A%84%E9%A3%8E%E6%8E%A7%E6%9E%B6%E6%9E%84%E5%87%BA%E5%8F%91%EF%BC%8C%E5%A6%82%E4%BD%95%E7%90%86%E8%A7%A3DDD%E6%80%9D%E6%83%B3/classical_v1.png"><br>我们抽取两个模块，从实现功能角度来看一下存在哪些问题</p>
<table>
  <tr>
    <th>模块</th>
    <th>职责</th>
  </tr>
  <tr>
<td>图像处理模块（pi-image）</td>
<td>图片审核请求参数的校验<br>业务数据记录<br>图片获取<br>图像的截帧<br><span style="color: red;">截帧图像处理<br>基础设施层调用及结果整合</span></td>
</tr>
 <tr>
<td>视频文件处理模块（pi-vidoe）</td>
<td>视频文件审核参数的校验<br>业务数据记录<br>文件获取<br>视频截帧抽取<br>视频音频片段切分<br><span style="color: red;">截帧图像的处理<br>基础设施层调用及结果整合</span>
</td>
  </tr>
</table>
我们会发现，两个模块除了各自的媒体形式逻辑以外，都在做相同的截帧图像的处理、基础设施层调用及结果整合功能。并且这两个具体功能中包含大量的业务逻辑且会经常性的迭代变更。

<h3 id="怎么从质量和效率的角度论证呢"><a href="#怎么从质量和效率的角度论证呢" class="headerlink" title="怎么从质量和效率的角度论证呢"></a>怎么从质量和效率的角度论证呢</h3><h2 id="如何改进？"><a href="#如何改进？" class="headerlink" title="如何改进？"></a>如何改进？</h2><blockquote>
<p>为什么不抽象独立的视觉对象？</p>
<blockquote>
<p>该对象负责图片业务截帧、视频文件业务截帧、视频流业务截帧、网页业务截帧等所有视觉对象的审核功能。</p>
</blockquote>
</blockquote>
<h3 id="独立视觉对象的架构"><a href="#独立视觉对象的架构" class="headerlink" title="独立视觉对象的架构"></a>独立视觉对象的架构</h3><p>先说第一版尝试优化的结果：我们将多种互联网媒体形式下的三种基础内容进行抽象。每种基础内容对象的所有功能放到子域内，向上层提供简单的对象审核 API。</p>
<ul>
<li>视觉对象：视觉截帧（可以是图片、视频、网页等多种来源）</li>
<li>语义对象：文本片段（可以是文本、OCR、ASR 等多种来源）</li>
<li>语音对象：音频片段（可以是音频、视频音频等多种来源）<br><img src="/2025/04/18/%E4%BB%8E%E6%95%B0%E7%BE%8E%E7%A7%91%E6%8A%80%E7%9A%84%E9%A3%8E%E6%8E%A7%E6%9E%B6%E6%9E%84%E5%87%BA%E5%8F%91%EF%BC%8C%E5%A6%82%E4%BD%95%E7%90%86%E8%A7%A3DDD%E6%80%9D%E6%83%B3/DDD_v2.png"><br>修改后从架构设计角度来看有哪些改变：</li>
<li>修改独立性：各对象独立修改、发布，可按照业务单元进行拆分</li>
<li>一处一事实：避免多处实现修改不一致等质量效率问题</li>
<li>概念多样性：支持领域对象独立扩展，支持语音对象、行为事件对象等</li>
</ul>
<h3 id="改进后与-DDD-的思想还有哪些差异？"><a href="#改进后与-DDD-的思想还有哪些差异？" class="headerlink" title="改进后与 DDD 的思想还有哪些差异？"></a>改进后与 DDD 的思想还有哪些差异？</h3>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/04/17/ThriftRPC%E6%A1%86%E6%9E%B6-%E8%AF%B7%E6%B1%82%E4%BC%98%E5%85%88%E7%BA%A7%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Saifei Song">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="MoonlitAlley">
    </span>

    
    
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/04/17/ThriftRPC%E6%A1%86%E6%9E%B6-%E8%AF%B7%E6%B1%82%E4%BC%98%E5%85%88%E7%BA%A7%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86/" class="post-title-link" itemprop="url">ThriftRPC框架-请求优先级实现原理</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2025-04-17 22:32:34" itemprop="dateCreated datePublished" datetime="2025-04-17T22:32:34+08:00">2025-04-17</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">Edited on</span>
        <time title="Modified: 2025-04-18 13:29:07" itemprop="dateModified" datetime="2025-04-18T13:29:07+08:00">2025-04-18</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1/" itemprop="url" rel="index"><span itemprop="name">架构设计</span></a>
        </span>
    </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/2025/04/17/ThriftRPC%E6%A1%86%E6%9E%B6-%E8%AF%B7%E6%B1%82%E4%BC%98%E5%85%88%E7%BA%A7%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2025/04/17/ThriftRPC%E6%A1%86%E6%9E%B6-%E8%AF%B7%E6%B1%82%E4%BC%98%E5%85%88%E7%BA%A7%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/04/17/C-%E5%BC%82%E5%B8%B8%E5%88%86%E7%B1%BB%E4%B8%8E%E5%A4%84%E7%90%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Saifei Song">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="MoonlitAlley">
    </span>

    
    
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/04/17/C-%E5%BC%82%E5%B8%B8%E5%88%86%E7%B1%BB%E4%B8%8E%E5%A4%84%E7%90%86/" class="post-title-link" itemprop="url">C++异常分类与处理</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2025-04-17 22:31:11" itemprop="dateCreated datePublished" datetime="2025-04-17T22:31:11+08:00">2025-04-17</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">Edited on</span>
        <time title="Modified: 2025-04-18 13:29:15" itemprop="dateModified" datetime="2025-04-18T13:29:15+08:00">2025-04-18</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/C/" itemprop="url" rel="index"><span itemprop="name">C++</span></a>
        </span>
    </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/2025/04/17/C-%E5%BC%82%E5%B8%B8%E5%88%86%E7%B1%BB%E4%B8%8E%E5%A4%84%E7%90%86/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2025/04/17/C-%E5%BC%82%E5%B8%B8%E5%88%86%E7%B1%BB%E4%B8%8E%E5%A4%84%E7%90%86/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/04/17/%E9%87%8D%E5%8F%A0%E5%AE%9E%E9%AA%8C%E6%9E%B6%E6%9E%84%E5%9F%BA%E7%A1%80%E8%AE%BE%E6%96%BD/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Saifei Song">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="MoonlitAlley">
    </span>

    
    
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/04/17/%E9%87%8D%E5%8F%A0%E5%AE%9E%E9%AA%8C%E6%9E%B6%E6%9E%84%E5%9F%BA%E7%A1%80%E8%AE%BE%E6%96%BD/" class="post-title-link" itemprop="url">重叠实验架构基础设施</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2025-04-17 22:29:50" itemprop="dateCreated datePublished" datetime="2025-04-17T22:29:50+08:00">2025-04-17</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">Edited on</span>
        <time title="Modified: 2025-04-18 13:29:20" itemprop="dateModified" datetime="2025-04-18T13:29:20+08:00">2025-04-18</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1/" itemprop="url" rel="index"><span itemprop="name">架构设计</span></a>
        </span>
    </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/2025/04/17/%E9%87%8D%E5%8F%A0%E5%AE%9E%E9%AA%8C%E6%9E%B6%E6%9E%84%E5%9F%BA%E7%A1%80%E8%AE%BE%E6%96%BD/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2025/04/17/%E9%87%8D%E5%8F%A0%E5%AE%9E%E9%AA%8C%E6%9E%B6%E6%9E%84%E5%9F%BA%E7%A1%80%E8%AE%BE%E6%96%BD/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/04/17/%E6%8E%A8%E8%8D%90%E6%9E%B6%E6%9E%84%E7%9A%84%E5%B7%A5%E7%A8%8B%E6%8B%86%E8%A7%A3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Saifei Song">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="MoonlitAlley">
    </span>

    
    
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/04/17/%E6%8E%A8%E8%8D%90%E6%9E%B6%E6%9E%84%E7%9A%84%E5%B7%A5%E7%A8%8B%E6%8B%86%E8%A7%A3/" class="post-title-link" itemprop="url">推荐架构的工程拆解</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2025-04-17 22:27:06" itemprop="dateCreated datePublished" datetime="2025-04-17T22:27:06+08:00">2025-04-17</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">Edited on</span>
        <time title="Modified: 2025-04-18 11:21:17" itemprop="dateModified" datetime="2025-04-18T11:21:17+08:00">2025-04-18</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1/" itemprop="url" rel="index"><span itemprop="name">架构设计</span></a>
        </span>
    </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/2025/04/17/%E6%8E%A8%E8%8D%90%E6%9E%B6%E6%9E%84%E7%9A%84%E5%B7%A5%E7%A8%8B%E6%8B%86%E8%A7%A3/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2025/04/17/%E6%8E%A8%E8%8D%90%E6%9E%B6%E6%9E%84%E7%9A%84%E5%B7%A5%E7%A8%8B%E6%8B%86%E8%A7%A3/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/04/16/read-committed%E4%B8%8BGAP%E9%94%81%E9%97%AE%E9%A2%98/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Saifei Song">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="MoonlitAlley">
    </span>

    
    
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/04/16/read-committed%E4%B8%8BGAP%E9%94%81%E9%97%AE%E9%A2%98/" class="post-title-link" itemprop="url">read-committed下GAP锁问题</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2021-04-16 11:57:13" itemprop="dateCreated datePublished" datetime="2021-04-16T11:57:13+08:00">2021-04-16</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">Edited on</span>
        <time title="Modified: 2025-04-18 13:24:57" itemprop="dateModified" datetime="2025-04-18T13:24:57+08:00">2025-04-18</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/MySQL/" itemprop="url" rel="index"><span itemprop="name">MySQL</span></a>
        </span>
    </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/2021/04/16/read-committed%E4%B8%8BGAP%E9%94%81%E9%97%AE%E9%A2%98/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2021/04/16/read-committed%E4%B8%8BGAP%E9%94%81%E9%97%AE%E9%A2%98/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>[TOC]</p>
<p>最近在定位一个数据库偶尔出现死锁的问题， 现象就是数据库在read-committed隔离级别下出现GAP锁，导致部分insert语句发生死锁、业务侧超时。<br>在这里记录下排查过程和结论，同时讨论以下几个问题<br>数据库各隔离级别及GAP锁的定义<br>GAP锁为什么会出现在read-committed隔离级别下<br>从哪些角度能避免死锁问题（在当前场景下）</p>
<h3 id="问题背景"><a href="#问题背景" class="headerlink" title="问题背景"></a>问题背景</h3><p>先讲一下背景，业务中对数据库的操作分为读、更新、插入三类， 其中因为对数据库更新某个key的特定field的value时，因为无法判断该值是否已经写入到数据库中了， 所以需要使用on duplicate key 语句。<br>如果想避免该语句的话，也有几种方案可以实现此功能， 这个在后面的部分来讨论，大致来说就是将一条 on duplicate key 拆分为update 和 insert，需要的时候再使用 insert。<br>执行语句<br>业务中所有的数据库插入语句都是这种格式，执行语句中具体拼接的数量可以动态配置，默认情况下同key的不同field才会进行合并，大概5-10个field合并为一个执行语句。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="keyword">table</span> (<span class="string">`key`</span>,<span class="string">`originalKey`</span>,<span class="string">`field`</span>,<span class="string">`value`</span>)</span><br><span class="line"><span class="keyword">values</span></span><br><span class="line">(),</span><br><span class="line">...</span><br><span class="line"><span class="keyword">ON</span> <span class="keyword">DUPLICATE</span> <span class="keyword">KEY</span> <span class="keyword">UPDATE</span> <span class="string">`value`</span> = <span class="keyword">VALUES</span>(<span class="keyword">value</span>), <span class="string">`expire`</span>= <span class="keyword">VALUES</span>(<span class="keyword">expire</span>), <span class="string">`modifyTime`</span> = <span class="keyword">NOW</span>()</span><br></pre></td></tr></table></figure>
<h4 id="为什么不用replace？"><a href="#为什么不用replace？" class="headerlink" title="为什么不用replace？"></a>为什么不用replace？</h4><p>on duplicate key 与  replace的性能差异(有时间了再补充相关文档)<br>replace在检测的key冲突是执行的具体语句为 delete + insert，该操作将额外进行两次索引操作。<br>建表语句</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">DATABASE</span> <span class="string">`profile_storage`</span> <span class="comment">/*!40100 DEFAULT CHARACTER SET utf8mb4 */</span>;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`storage_cluster`</span> (</span><br><span class="line"> <span class="string">`id`</span> <span class="built_in">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT,</span><br><span class="line"> <span class="string">`key`</span> <span class="built_in">varchar</span>(<span class="number">128</span>) <span class="keyword">COLLATE</span> utf8mb4_bin <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;存储key&#x27;</span>,</span><br><span class="line"> <span class="string">`originalKey`</span> <span class="built_in">varchar</span>(<span class="number">255</span>) <span class="keyword">COLLATE</span> utf8mb4_bin <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;原始key&#x27;</span>,</span><br><span class="line"> <span class="string">`field`</span> <span class="built_in">varchar</span>(<span class="number">128</span>) <span class="keyword">COLLATE</span> utf8mb4_bin <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;存储列名&#x27;</span>,</span><br><span class="line"> <span class="string">`value`</span> <span class="built_in">blob</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;value, json&#x27;</span>,</span><br><span class="line"> <span class="string">`expire`</span> <span class="built_in">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;写入时的有效时间，清理结合modifyTime+expire即可&#x27;</span>,</span><br><span class="line"> <span class="string">`modifyTime`</span> <span class="built_in">timestamp</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="keyword">CURRENT_TIMESTAMP</span> <span class="keyword">ON</span> <span class="keyword">UPDATE</span> <span class="keyword">CURRENT_TIMESTAMP</span>,</span><br><span class="line"> PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>),</span><br><span class="line"> <span class="keyword">UNIQUE</span> <span class="keyword">KEY</span> <span class="string">`key_field`</span> (<span class="string">`key`</span>,<span class="string">`field`</span>),</span><br><span class="line"> <span class="keyword">KEY</span> <span class="string">`modify_time`</span> (<span class="string">`modifyTime`</span>)</span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8mb4 <span class="keyword">COLLATE</span>=utf8mb4_bin <span class="keyword">COMMENT</span>=<span class="string">&#x27;画像数据存储&#x27;</span>;</span><br></pre></td></tr></table></figure>
<p>隔离级别</p>
<blockquote>
<p>tx_isolation = READ-COMMITTED</p>
</blockquote>
<h3 id="排查过程"><a href="#排查过程" class="headerlink" title="排查过程"></a>排查过程</h3><p>使用腾讯云DBbrain<br>我们使用的腾讯云的MySQL，腾讯云提供的数据库智能管家DBbrain可以很方便的查看当前和历史时刻的数据库状态。刚好这两天发生了一次deadlock，通过这个截图可以看下DBbrain的总览。<br><img src="/2021/04/16/read-committed%E4%B8%8BGAP%E9%94%81%E9%97%AE%E9%A2%98/dead_lock.png"></p>
<p>当点击死锁字段时会自动跳转到错误日志界面（包含事件详情和死锁快照）， 下面是死锁快照部分的具体日志</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">------------------------</span><br><span class="line">2021-04-18 11:18:47 0x7ff915060700</span><br><span class="line">*** (1) TRANSACTION:</span><br><span class="line">TRANSACTION 101037787573, ACTIVE 0 sec inserting</span><br><span class="line">mysql tables <span class="keyword">in</span> use 1, locked 1</span><br><span class="line">LOCK WAIT 2 lock struct(s), heap size 1136, 1 row lock(s), undo <span class="built_in">log</span> entries 2</span><br><span class="line">MySQL thread id 3527624187, OS thread handle 140694797604608, query id 72846449145 10.0.129.132 smonline update</span><br><span class="line">INSERT INTO `storage_cluster` ( `id`,`key`,`originalKey`,`field`,`value`,`expire` ) VALUES ( <span class="string">&#x27;0&#x27;</span>, <span class="string">&#x27;15de83fc9a9f9834d8f4d7bfa9ff4713&#x27;</span>, <span class="string">&#x27;profile:smid:2020091521544905a3711528ba4a2e159d6f2230360a5001b6047b1f8904e4&#x27;</span>, <span class="string">&#x27;b_device_manufacturer&#x27;</span>, <span class="string">&#x27;\&quot;xiaomi\&quot;&#x27;</span>, 15552000 ) , ( <span class="string">&#x27;0&#x27;</span>, <span class="string">&#x27;15de83fc9a9f9834d8f4d7bfa9ff4713&#x27;</span>, <span class="string">&#x27;profile:smid:2020091521544905a3711528ba4a2e159d6f2230360a5001b6047b1f8904e4&#x27;</span>, <span class="string">&#x27;device_score&#x27;</span>, <span class="string">&#x27;199&#x27;</span>, 15552000 ) , ( <span class="string">&#x27;0&#x27;</span>, <span class="string">&#x27;15de83fc9a9f9834d8f4d7bfa9ff4713&#x27;</span>, <span class="string">&#x27;profile:smid:2020091521544905a3711528ba4a2e159d6f2230360a5001b6047b1f8904e4&#x27;</span>, <span class="string">&#x27;last_active_time&#x27;</span>, <span class="string">&#x27;1618715927103&#x27;</span>, 15552000 ) ON DUPLICATE KEY UPDATE `value` = VALUES(value), `expire`= VALUES(expire), `modifyTime` = NOW()</span><br><span class="line">*** (1) WAITING FOR THIS LOCK TO BE GRANTED:</span><br><span class="line">RECORD LOCKS space id 43 page no 27774151 n bits 328 index key_field of table `profile_storage`.`storage_cluster` trx id 101037787573 lock_mode X waiting</span><br><span class="line">Record lock, heap no 2 PHYSICAL RECORD: n_fields 3; compact format; info bits 0</span><br><span class="line"> 0: len 30; hex 313564653833666339613966393833346438663464376266613966663437; asc 15de83fc9a9f9834d8f4d7bfa9ff47; (total 32 bytes);</span><br><span class="line"> 1: len 12; hex 6465766963655f73636f7265; asc device_score;;</span><br><span class="line"> 2: len 8; hex 8000000e95317813; asc 1x ;;</span><br><span class="line"></span><br><span class="line">*** (2) TRANSACTION:</span><br><span class="line">TRANSACTION 101037787572, ACTIVE 0 sec inserting</span><br><span class="line">mysql tables <span class="keyword">in</span> use 1, locked 1</span><br><span class="line">4 lock struct(s), heap size 1136, 3 row lock(s), undo <span class="built_in">log</span> entries 1</span><br><span class="line">MySQL thread id 3527607500, OS thread handle 140707776300800, query id 72846449143 10.0.129.31 smonline update</span><br><span class="line">INSERT INTO `storage_cluster` ( `id`,`key`,`originalKey`,`field`,`value`,`expire` ) VALUES ( <span class="string">&#x27;0&#x27;</span>, <span class="string">&#x27;15de83fc9a9f9834d8f4d7bfa9ff4713&#x27;</span>, <span class="string">&#x27;profile:smid:2020091521544905a3711528ba4a2e159d6f2230360a5001b6047b1f8904e4&#x27;</span>, <span class="string">&#x27;bssid&#x27;</span>, <span class="string">&#x27;\&quot;020000000000\&quot;&#x27;</span>, 172800 ) ON DUPLICATE KEY UPDATE `value` = VALUES(value), `expire`= VALUES(expire), `modifyTime` = NOW()</span><br><span class="line">*** (2) HOLDS THE LOCK(S):</span><br><span class="line">RECORD LOCKS space id 43 page no 27774151 n bits 328 index key_field of table `profile_storage`.`storage_cluster` trx id 101037787572 lock_mode X</span><br><span class="line">Record lock, heap no 2 PHYSICAL RECORD: n_fields 3; compact format; info bits 0</span><br><span class="line"> 0: len 30; hex 313564653833666339613966393833346438663464376266613966663437; asc 15de83fc9a9f9834d8f4d7bfa9ff47; (total 32 bytes);</span><br><span class="line"> 1: len 12; hex 6465766963655f73636f7265; asc device_score;;</span><br><span class="line"> 2: len 8; hex 8000000e95317813; asc 1x ;;</span><br><span class="line"></span><br><span class="line">*** (2) WAITING FOR THIS LOCK TO BE GRANTED:</span><br><span class="line">RECORD LOCKS space id 43 page no 27774151 n bits 328 index key_field of table `profile_storage`.`storage_cluster` trx id 101037787572 lock_mode X locks gap before rec insert intention waiting</span><br><span class="line">Record lock, heap no 2 PHYSICAL RECORD: n_fields 3; compact format; info bits 0</span><br><span class="line"> 0: len 30; hex 313564653833666339613966393833346438663464376266613966663437; asc 15de83fc9a9f9834d8f4d7bfa9ff47; (total 32 bytes);</span><br><span class="line"> 1: len 12; hex 6465766963655f73636f7265; asc device_score;;</span><br><span class="line"> 2: len 8; hex 8000000e95317813; asc 1x ;;</span><br><span class="line"></span><br><span class="line">*** WE ROLL BACK TRANSACTION (1)</span><br></pre></td></tr></table></figure>
<p>使用MySQL日志<br>这部分内容同样可以通过MySQL本身的错误日志查看MySQL - The Error Log）</p>
<h3 id="问题分析"><a href="#问题分析" class="headerlink" title="问题分析"></a>问题分析</h3><p>通过日志描述可以清楚定位发生死锁的两条语句和死锁详情</p>
<h4 id="为什么出现并发？"><a href="#为什么出现并发？" class="headerlink" title="为什么出现并发？"></a>为什么出现并发？</h4><p>业务中该数据库实例仅由画像引擎使用，画像引擎向上层的业务模块提供实体标签的查询和记录。 由于上层不同模块同时对同一个实体进行写操作，导致画像引擎部分发生 同  UNIQUE KEY的并发INSERT 操作</p>
<h4 id="出现的是什么锁？"><a href="#出现的是什么锁？" class="headerlink" title="出现的是什么锁？"></a>出现的是什么锁？</h4><p>死锁快照的最后一部分有这样一段描述</p>
<blockquote>
<p>trx id 101037787572 lock_mode X locks gap before rec insert intention waiting<br>引用1 中有对该错误出现原因的详细分析，文档中有对该错误的定义Insert Intention Locks<br>An insert intention lock is a type of gap lock set by INSERT operations prior to row insertion</p>
</blockquote>
<p>可以看到Insert Intention Locks属于Gap锁的一种，但是MySQL官方文档中对gap-locks定义innodb-gap-locks中有说明RC级别可以禁用Gap锁，那为什么还会出现这个问题呢。</p>
<blockquote>
<p>Gap locking can be disabled explicitly. This occurs if you change the transaction isolation level to READ COMMITTED. Under these circumstances, gap locking is disabled for searches and index scans and is used only for foreign-key constraint checking and duplicate-key checking.</p>
</blockquote>
<h3 id="为什么会现Gap锁"><a href="#为什么会现Gap锁" class="headerlink" title="为什么会现Gap锁"></a>为什么会现Gap锁</h3><blockquote>
<p>lock_mode X locks gap before rec insert intention waiting</p>
</blockquote>
<p>假设一个存在如下这样一个数据前提（具体信息可以在引用1中查看），当我们执行事务1按照order_type=2条件更新，因此先使用索引idx_order_type定位到order_type=2的记录并加锁(ROW LOCK)，再根据二级索引上包含的主键索引值找到表上order_id=2和order_id=4的记录并加锁(ROW LOCK)，加锁如下：<br><img src="/2021/04/16/read-committed%E4%B8%8BGAP%E9%94%81%E9%97%AE%E9%A2%98/idx_order_type.png"></p>
<ul>
<li>当我们同时执行事务2按照order_id=3条件更新，先根据主键定位到order_id=3并加锁(ROW LOCK)，然后根据主键中数据(order_type=1+ order_id=3)到索引idx_order_type上找到满足条件的记录并加锁，UPDATE操作将数据(1,3)更新为(2,3)，因此会将索引idx_order_type上记录(1,3)标记为删除，然后在记录(2,2)和(2,4)之间插入新记录(2,3),在插入记录前，为防止其他事务在该物理位置上插入其他数据，需要先在索引idx_order_type上申请记录(2,2)和(2,4)之间插入意向锁(Insert Intention Gap Lock),其加锁如下：<br><img src="/2021/04/16/read-committed%E4%B8%8BGAP%E9%94%81%E9%97%AE%E9%A2%98/idx_order_type_insert.png"></li>
<li>而由于索引记录(2,4)上已被事务1加锁（X LOCK+ ROW LOCK）,因此导致加插入意向锁(Insert Intention Gap Lock)被阻塞，处于“lock_mode X locks gap before rec insert intention waiting”的等待状态。<h4 id="RR及以上隔离级别为什么会出现-加锁策略"><a href="#RR及以上隔离级别为什么会出现-加锁策略" class="headerlink" title="RR及以上隔离级别为什么会出现 - 加锁策略"></a>RR及以上隔离级别为什么会出现 - 加锁策略</h4>对于这个错误的具体定义是：在事务插入数据过程中，为防止其他事务向索引上该位置插入数据，会在插入之前先申请插入意向范围锁，而如果申请插入意向范围锁被阻塞，则事务处于gap before rec insert intention waiting的等待状态。这篇文章中很形象的介绍了MySQL中的各类锁：说说你是怎么解决MySQL死锁的<br>我们先看下 官方定义中insert 语句的加锁策略：<blockquote>
<p>“INSERT sets an exclusive lock on the inserted row. This lock is an index-record lock, not a next-key lock (that is, there is no gap lock) and does not prevent other sessions from inserting into the gap before the inserted row.<br>Prior to inserting the row, a type of gap lock called an insert intention gap lock is set. This lock signals the intent to insert in such a way that multiple transactions inserting into the same index gap need not wait for each other if they are not inserting at the same position within the gap. ”</p>
</blockquote>
</li>
</ul>
<p>我们知道事务执行insert的时候会申请一把插入意向锁(Insert Intention Lock)。在多个会话并发写入不同数据记录至同一索引间隙的时候，并不需要等待其他事务完成，不会发生锁等待。<br>假设有一个索引记录包含键值4和7，不同的会话分别插入5和6，每个事务都会产生一个加在4-7之间的插入意向锁，获取在插入行上的排它锁，但是不会被互相锁住，因为数据行并不冲突。<br>当前情况为什么会出现 - 补充说明<br>但是如果遇到唯一键呢？<br>( Under these circumstances指的就是 transaction isolation level READ COMMITTED) </p>
<blockquote>
<p>Under these circumstances, gap locking is disabled for searches and index scans and is used only for foreign-key constraint checking and duplicate-key checking.<br>同时insert加锁策略中也有描述<br>If a duplicate-key error occurs, a shared lock on the duplicate index record is set. This use of a shared lock can result in deadlock should there be multiple sessions trying to insert the same row if another session already has an exclusive lock.<br>对于insert操作来说，若发生唯一约束冲突，则需要对冲突的唯一索引加上S Next-key Lock。从这里会发现，即使是RC事务隔离级别，也同样会存在Next-Key Lock锁，从而阻塞并发。然而，文档没有说明的是，对于检测到冲突的唯一索引，等待线程在获得S Lock之后，还需要对下一个记录进行加锁，在源码中由函数row_ins_scan_sec_index_for_duplicate进行判断。<br>普通索引和唯一索引的区别<br>为什么在RC级别下Gap会与唯一索引有关呢？ 唯一索引有普通索引有什么区别？ 能否通过将唯一索引替换为普通索引来解决此问题？<br>// TODO </p>
</blockquote>
<h2 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h2><p>虽然Gap锁只作用在隔离级别为RR及以上的数据库上， 但是不意味着隔离级别为RC 级别的不会使用。 RC级别在进行外键约束检测和唯一键约束检测的时候，会使用到Gap锁， 而正是这个 duplicate-key checking 导致了上文出现的死锁发生。</p>
<h3 id="优化方法"><a href="#优化方法" class="headerlink" title="优化方法"></a>优化方法</h3><p>拆分执行语句 - 减小合并记录数量<br>拆分执行语句 - update + insert<br>同类问题和相关文档<br>这里记录一下排查问题过程中浏览到的一些文档，其实官方文档永远是做好的参考手册，笔记中的引用也尽量去找对应的官方说明了，但是在没有找到用好官方文档的技巧之前，大佬翻译和图解过的内容看起来会简单一些。</p>
<h3 id="同类问题及相关文档"><a href="#同类问题及相关文档" class="headerlink" title="同类问题及相关文档"></a>同类问题及相关文档</h3><ol>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/gaogao67/p/11042853.html">MySQL Lock–gap before rec insert intention waiting</a></li>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/crazylqy/p/7689447.html">初步理解MySQL的gap锁</a></li>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/LBSer/p/5183300.html">mysql死锁问题分析</a></li>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/zhjh256/p/6051839.html">mysql 5.6 read-committed隔离级别下并发插入唯一索引导致死锁一例（GAP锁的问题）</a></li>
<li><a target="_blank" rel="noopener" href="http://www.kokojia.com/article/42839.html">数据库：MySQL 普通索引和唯一索引的区别</a></li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/04/10/vcpkg%E4%BD%BF%E7%94%A8%E7%A4%BA%E4%BE%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Saifei Song">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="MoonlitAlley">
    </span>

    
    
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/04/10/vcpkg%E4%BD%BF%E7%94%A8%E7%A4%BA%E4%BE%8B/" class="post-title-link" itemprop="url">vcpkg使用示例</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2021-04-10 19:19:39" itemprop="dateCreated datePublished" datetime="2021-04-10T19:19:39+08:00">2021-04-10</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">Edited on</span>
        <time title="Modified: 2025-04-17 23:36:51" itemprop="dateModified" datetime="2025-04-17T23:36:51+08:00">2025-04-17</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/c/" itemprop="url" rel="index"><span itemprop="name">c++</span></a>
        </span>
    </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/2021/04/10/vcpkg%E4%BD%BF%E7%94%A8%E7%A4%BA%E4%BE%8B/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2021/04/10/vcpkg%E4%BD%BF%E7%94%A8%E7%A4%BA%E4%BE%8B/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>尝试一次之后： 泪流满面， 后悔自己昨天还在熬夜编译一个第三方库文件</p>
<h3 id="官方文档"><a href="#官方文档" class="headerlink" title="官方文档"></a>官方文档</h3><ul>
<li><a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/cpp/build/vcpkg?view=msvc-160">Microsoft vcpkg：适用于C++ 的包管理器</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/Microsoft/vcpkg">github microsoft/vcpkg</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/microsoft/vcpkg/blob/master/README_zh_CN.md">vcpkg/README_zh_CN.md</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/microsoft/vcpkg/blob/master/docs/examples/installing-and-using-packages.md">vcpkg/docs/examples/installing-and-using-packages</a></li>
</ul>
<h3 id="使用示例"><a href="#使用示例" class="headerlink" title="使用示例"></a>使用示例</h3><p>示例项目中依赖nlohmann_json、 gflags两个第三方库文件，其中</p>
<ul>
<li>nlohmann_json 仅需要导入头文件</li>
<li>gflags 需要引入头文件，同时链接动态库文件<br>该项目主要功能为通过gflags功能读取配置文件中的参数，将参数值放入json对象中，并打印到屏幕<br><a target="_blank" rel="noopener" href="https://github.com/MoonlitAlley/vc_test">项目链接</a></li>
</ul>
<h4 id="目录结构"><a href="#目录结构" class="headerlink" title="目录结构"></a>目录结构</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">» tree -L 1</span><br><span class="line">.</span><br><span class="line">├── CMakeLists.txt</span><br><span class="line">├── flags.conf</span><br><span class="line">├── main.cpp</span><br><span class="line">└── vcpkg</span><br><span class="line"></span><br><span class="line">2 directories, 3 files</span><br></pre></td></tr></table></figure>

<p>cat flags.conf</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">--storage_config&#x3D;test_storage</span><br></pre></td></tr></table></figure>
<h4 id="如何编写CMakeLists-txt"><a href="#如何编写CMakeLists-txt" class="headerlink" title="如何编写CMakeLists.txt"></a>如何编写CMakeLists.txt</h4><blockquote>
<p>在CMakeLists.txt中直接设置CMAKE_TOOLCHAIN_FILE，此种方式可无需设置 CMAKE_TOOLCHAIN_FILE 即可使用vcpkg，且更容易完成配置工作。<br>文件中的find_package与target_link_libraries均有vcpkg直接提供，用户只需要复制到自己的CMakeLists.txt文件中即可使用</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt; cat CMakeLists.txt</span><br><span class="line">cmake_minimum_required(VERSION 3.17)</span><br><span class="line">set(CMAKE_TOOLCHAIN_FILE $&#123;CMAKE_CURRENT_SOURCE_DIR&#125;&#x2F;vcpkg&#x2F;scripts&#x2F;buildsystems&#x2F;vcpkg.cmake</span><br><span class="line">        CACHE STRING &quot;Vcpkg toolchain file&quot;)</span><br><span class="line"></span><br><span class="line">project(vc_test)</span><br><span class="line">set(CMAKE_CXX_STANDARD 14)</span><br><span class="line"></span><br><span class="line">find_package(nlohmann_json CONFIG REQUIRED)</span><br><span class="line">find_package(gflags CONFIG REQUIRED)</span><br><span class="line"></span><br><span class="line">add_executable(vc_test main.cpp)</span><br><span class="line">target_link_libraries(vc_test PRIVATE nlohmann_json nlohmann_json::nlohmann_json)</span><br><span class="line">target_link_libraries(vc_test PRIVATE gflags_static)</span><br></pre></td></tr></table></figure>


<p>源代码文件如下（gflags用法可以参考官方库文档）：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt; cat main.cpp</span><br><span class="line">#include &lt;iostream&gt;</span><br><span class="line">#include &quot;nlohmann&#x2F;json.hpp&quot;</span><br><span class="line">#include &quot;gflags&#x2F;gflags.h&quot;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; DECLARE_string(storage_config);</span><br><span class="line">DEFINE_string(storage_config, &quot;test_default&quot;, &quot;storage_config&quot;);</span><br><span class="line"></span><br><span class="line">int main(int argc, char** argv) &#123;</span><br><span class="line">    nlohmann::json json_value &#x3D; nlohmann::json::object();</span><br><span class="line">    std::cout &lt;&lt; argv &lt;&lt; std::endl;</span><br><span class="line">    gflags::ParseCommandLineFlags(&amp;argc, &amp;argv, true);</span><br><span class="line"></span><br><span class="line">    json_value[FLAGS_storage_config] &#x3D; &quot;get_any_storage&quot;;</span><br><span class="line">    json_value[&quot;test_key&quot;] &#x3D; &quot;test_value&quot;;</span><br><span class="line">    std::cout &lt;&lt; json_value.dump() &lt;&lt; std::endl;</span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="执行及输出结果"><a href="#执行及输出结果" class="headerlink" title="执行及输出结果"></a>执行及输出结果</h4><p>项目执行需设置flags参数路径<br><img src="/2021/04/10/vcpkg%E4%BD%BF%E7%94%A8%E7%A4%BA%E4%BE%8B/vc_test_build.png"><br>执行结果</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;Users&#x2F;momboguo&#x2F;Downloads&#x2F;workspace&#x2F;ishumei&#x2F;arch&#x2F;vc-test&#x2F;cmake-build-debug&#x2F;vc_test -flagfile&#x3D;..&#x2F;flags.conf</span><br><span class="line">0x7ffeebd27a48</span><br><span class="line">&#123;&quot;test_key&quot;:&quot;test_value&quot;,&quot;test_storage&quot;:&quot;get_any_storage&quot;&#125;</span><br><span class="line"></span><br><span class="line">Process finished with exit code 0</span><br></pre></td></tr></table></figure>


<h3 id="vcpkg介绍"><a href="#vcpkg介绍" class="headerlink" title="vcpkg介绍"></a>vcpkg介绍</h3><h4 id="在-macOS-上复制和设置-vcpkg"><a href="#在-macOS-上复制和设置-vcpkg" class="headerlink" title="在 macOS 上复制和设置 vcpkg"></a>在 macOS 上复制和设置 vcpkg</h4><ol>
<li>在“终端”窗口中，为 vcpkg 的克隆实例创建目录。 如果打算为不同的生成目标安装库，最好在目录名称中包含目标。 建议使用短路径名称（不含空格）（如 ./macos 或 ./iot），否则，某些端口生成系统可能会出现路径问题 。 在“终端”窗口中，切换到刚刚创建的目录。</li>
<li>从 GitHub 克隆 vcpkg 存储库：<a target="_blank" rel="noopener" href="https://github.com/Microsoft/vcpkg%E3%80%82">https://github.com/Microsoft/vcpkg。</a><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git clone https:&#x2F;&#x2F;github.com&#x2F;microsoft&#x2F;vcpkg</span><br></pre></td></tr></table></figure>
 此命令在 vcpkg 子目录中创建存储库的本地副本。 此位置是此 vcpkg 克隆的 vcpkg 根目录。</li>
<li>接下来，切换到 vcpkg 根目录，并运行 vcpkg 引导程序命令：<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.&#x2F;bootstrap-vcpkg.sh</span><br></pre></td></tr></table></figure>
 引导程序将使用编译器、工具和标准库的位置配置 vcpkg。</li>
</ol>
<h4 id="CLion-中使用-vcpkg"><a href="#CLion-中使用-vcpkg" class="headerlink" title="CLion 中使用 vcpkg"></a>CLion 中使用 vcpkg</h4><p>打开 Toolchains 设置 (File &gt; Settings on Windows and Linux, CLion &gt; Preferences on macOS)， 并打开 CMake 设置 (Build, Execution, Deployment &gt; CMake)。 最后在 CMake options 中添加以下行:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-DCMAKE_TOOLCHAIN_FILE&#x3D;[vcpkg root]&#x2F;scripts&#x2F;buildsystems&#x2F;vcpkg.cmake</span><br></pre></td></tr></table></figure>
<p>遗憾的是，您必须手动将此选项加入每个项目配置文件中。</p>
<h4 id="将-vcpkg-作为一个子模块"><a href="#将-vcpkg-作为一个子模块" class="headerlink" title="将 vcpkg 作为一个子模块"></a>将 vcpkg 作为一个子模块</h4><p>当您希望将vcpkg作为一个子模块加入到您的工程中时， 您可以在第一个 project() 调用之前将以下内容添加到 CMakeLists.txt 中， 而无需将 CMAKE_TOOLCHAIN_FILE 传递给cmake调用。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">set(CMAKE_TOOLCHAIN_FILE $&#123;CMAKE_CURRENT_SOURCE_DIR&#125;&#x2F;vcpkg&#x2F;scripts&#x2F;buildsystems&#x2F;vcpkg.cmake CACHE STRING &quot;Vcpkg toolchain file&quot;)</span><br></pre></td></tr></table></figure>
<p>使用此种方式可无需设置 CMAKE_TOOLCHAIN_FILE 即可使用vcpkg，且更容易完成配置工作。</p>
<h4 id="安装第三方库"><a href="#安装第三方库" class="headerlink" title="安装第三方库"></a>安装第三方库</h4><p>使用vcpkg安装json、gflags库（傻瓜式操作）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">vcpkg(master) » .&#x2F;vcpkg install nlohmann-json</span><br><span class="line">Computing installation plan...</span><br><span class="line">The following packages are already installed:</span><br><span class="line">    nlohmann-json[core]:x64-osx -&gt; 3.9.1</span><br><span class="line">Package nlohmann-json:x64-osx is already installed</span><br><span class="line"></span><br><span class="line">Total elapsed time: 778 us</span><br><span class="line"></span><br><span class="line">The package nlohmann-json:x64-osx provides CMake targets:</span><br><span class="line"></span><br><span class="line">    find_package(nlohmann_json CONFIG REQUIRED)</span><br><span class="line">    target_link_libraries(main PRIVATE nlohmann_json nlohmann_json::nlohmann_json)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">vcpkg(master) » .&#x2F;vcpkg install gflags</span><br><span class="line">Computing installation plan...</span><br><span class="line">The following packages are already installed:</span><br><span class="line">    gflags[core]:x64-osx -&gt; 2.2.2-1</span><br><span class="line">Package gflags:x64-osx is already installed</span><br><span class="line"></span><br><span class="line">Total elapsed time: 367 us</span><br><span class="line"></span><br><span class="line">The package gflags:x64-osx provides CMake targets:</span><br><span class="line"></span><br><span class="line">    find_package(gflags CONFIG REQUIRED)</span><br><span class="line">    target_link_libraries(main PRIVATE gflags_static gflags::gflags_static)</span><br></pre></td></tr></table></figure>

<h4 id="目录结构-1"><a href="#目录结构-1" class="headerlink" title="目录结构"></a>目录结构</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">vcpkg(master) » tree -L 1</span><br><span class="line">.</span><br><span class="line">├── CHANGELOG.md</span><br><span class="line">├── CONTRIBUTING.md</span><br><span class="line">├── LICENSE.txt</span><br><span class="line">├── NOTICE.txt</span><br><span class="line">├── README.md</span><br><span class="line">├── README_es.md</span><br><span class="line">├── README_fr.md</span><br><span class="line">├── README_ko_KR.md</span><br><span class="line">├── README_zh_CN.md</span><br><span class="line">├── bootstrap-vcpkg.bat</span><br><span class="line">├── bootstrap-vcpkg.sh</span><br><span class="line">├── buildtrees</span><br><span class="line">├── docs</span><br><span class="line">├── downloads</span><br><span class="line">├── installed</span><br><span class="line">├── packages</span><br><span class="line">├── ports</span><br><span class="line">├── scripts</span><br><span class="line">├── toolsrc</span><br><span class="line">├── triplets</span><br><span class="line">├── vcpkg</span><br><span class="line">└── versions</span><br><span class="line"></span><br><span class="line">10 directories, 12 files</span><br></pre></td></tr></table></figure>

<h4 id="常用命令"><a href="#常用命令" class="headerlink" title="常用命令"></a>常用命令</h4><p>搜索</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">vcpkg(master) » ./vcpkg search json</span><br><span class="line">arrow[json]                           JSON file support</span><br><span class="line">bitserializer        0.10             Core part of C++ 17 library <span class="keyword">for</span> serialization to JSON, XML, YAML</span><br><span class="line">bitserializer[cpprestjson-archive]    Module <span class="keyword">for</span> support JSON (implementation based on the CppRestSDK library)</span><br><span class="line">bitserializer[pugixml-archive]        Module <span class="keyword">for</span> support XML (implementation based on the PugiXml library)</span><br><span class="line">bitserializer[rapidjson-archive]      Module <span class="keyword">for</span> support JSON (implementation based on the RapidJson library)</span><br><span class="line">bitserializer[rapidyaml-archive]      Module <span class="keyword">for</span> support YAML (implementation based on the RapidYaml library)</span><br><span class="line">bitserializer-cpp... <span class="built_in">alias</span>            Deprecated <span class="built_in">alias</span> <span class="keyword">for</span> bitserializer-cpprestjson</span><br><span class="line">bitserializer-rap... <span class="built_in">alias</span>            Deprecated <span class="built_in">alias</span> <span class="keyword">for</span> bitserializer-rapidjson</span><br><span class="line">boost-json           1.75.0           Boost json module</span><br><span class="line">cereal               1.3.0            a header-only C++11 serialization library (built <span class="keyword">in</span> support <span class="keyword">for</span> binary, XML an...</span><br><span class="line">cjson                2019-11-30-1     Ultralightweight JSON parser <span class="keyword">in</span> ANSI C</span><br><span class="line">cjson[utils]                          Enable building the cJSON_Utils library</span><br><span class="line">cpprestsdk           2.10.17          C++11 JSON, REST, and OAuth library</span><br><span class="line">cpprestsdk[brotli]                    Brotli compression support</span><br><span class="line">cpprestsdk[compression]               HTTP Compression support</span><br><span class="line">cpprestsdk[default-features]          Features installed by default</span><br><span class="line">cpprestsdk[websockets]                Websockets support</span><br><span class="line">jansson              2.13.1           Jansson is a C library <span class="keyword">for</span> encoding, decoding and manipulating JSON data</span><br><span class="line">jsmn                 2019-04-27       A minimalistic JSON parser <span class="keyword">in</span> C.</span><br><span class="line">json-c               2019-09-10<span class="comment">#1     A JSON implementation in C</span></span><br><span class="line">json-dto             0.2.11           A small header-only library <span class="keyword">for</span> converting data between json representation an...</span><br><span class="line">json-schema-valid... 2.1.0            This is a C++ library <span class="keyword">for</span> validating JSON documents based on a JSON Schema. Th...</span><br><span class="line">json-spirit          4.1.0-1          json parser using boost library</span><br><span class="line">json11               2017-06-20-2     json11 is a tiny JSON library <span class="keyword">for</span> C++11, providing JSON parsing and serializat...</span><br><span class="line">json5-parser         1.0.0<span class="comment">#2          An enhancement of the JSON Spirit C++ library to understand json5.</span></span><br><span class="line">jsoncons             0.159.0          A C++, header-only library <span class="keyword">for</span> constructing JSON and JSON-like text and binary...</span><br><span class="line">jsoncpp              1.9.4            jsoncpp is an implementation of a JSON reader and writer <span class="keyword">in</span> C++. JSON (JavaScr...</span><br><span class="line">jsonnet              0.16.0<span class="comment">#1         Jsonnet - The data templating language</span></span><br><span class="line">jwt-cpp              0.4.0            A header only library <span class="keyword">for</span> creating and validating json web tokens <span class="keyword">in</span> c++</span><br><span class="line">minitrace            2019.02.06       Simple C/C++ library <span class="keyword">for</span> producing JSON traces suitable <span class="keyword">for</span> Chrome<span class="string">&#x27;s built-in ...</span></span><br><span class="line"><span class="string">msgpack              3.3.0            MessagePack is an efficient binary serialization format, which lets you exchan...</span></span><br><span class="line"><span class="string">msgpack11            0.0.10-1         msgpack11 is a tiny MsgPack library for C++11, providing MsgPack parsing and s...</span></span><br><span class="line"><span class="string">nlohmann-json        3.9.1            JSON for Modern C++</span></span><br><span class="line"><span class="string">parson               2020-09-14       a lighweight json library written in C</span></span><br><span class="line"><span class="string">picojson             1.3.0-1          A header-file-only, JSON parser serializer in C++.</span></span><br><span class="line"><span class="string">rapidjson            2020-09-14       A fast JSON parser/generator for C++ with both SAX/DOM style API &lt;http://rapid...</span></span><br><span class="line"><span class="string">sajson               2018-09-21       Lightweight, extremely high-performance JSON parser for C++11</span></span><br><span class="line"><span class="string">simdjson             0.7.1            A extremely fast JSON library that can parse gigabytes of JSON per second</span></span><br><span class="line"><span class="string">sqlcipher[json1]                      enable JSON functionality for sqlite3</span></span><br><span class="line"><span class="string">sqlite3[json1]                        enable JSON functionality for sqlite3</span></span><br><span class="line"><span class="string">taocpp-json          2020-09-14       C++ header-only JSON library</span></span><br><span class="line"><span class="string">valijson             2018-11-17-1     Header-only C++ library for JSON Schema validation</span></span><br><span class="line"><span class="string">yajl                 2.1.0-1          Yet Another JSON Library</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">If your library is not listed, please open an issue at and/or consider making a pull request:</span></span><br><span class="line"><span class="string">    https://github.com/Microsoft/vcpkg/issues</span></span><br><span class="line"><span class="string"></span></span><br></pre></td></tr></table></figure>
<p>已安装</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vcpkg(master) » .&#x2F;vcpkg list</span><br><span class="line">sqlite3:x86-windows         3.32.1           SQLite is a software library that implements a se...</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/01/31/%E5%81%8F%E5%AE%89%E4%B8%80%E9%9A%85/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Saifei Song">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="MoonlitAlley">
    </span>

    
    
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/01/31/%E5%81%8F%E5%AE%89%E4%B8%80%E9%9A%85/" class="post-title-link" itemprop="url">偏安一隅</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2021-01-31 18:05:41" itemprop="dateCreated datePublished" datetime="2021-01-31T18:05:41+08:00">2021-01-31</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">Edited on</span>
        <time title="Modified: 2025-04-18 13:18:37" itemprop="dateModified" datetime="2025-04-18T13:18:37+08:00">2025-04-18</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%89%AA%E5%BD%B1/" itemprop="url" rel="index"><span itemprop="name">剪影</span></a>
        </span>
    </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/2021/01/31/%E5%81%8F%E5%AE%89%E4%B8%80%E9%9A%85/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2021/01/31/%E5%81%8F%E5%AE%89%E4%B8%80%E9%9A%85/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>出发：朝阳区来广营去往箭扣长城路上<br>mey be 范崎路<img src="/2021/01/31/%E5%81%8F%E5%AE%89%E4%B8%80%E9%9A%85/082.jpeg"><br><img src="/2021/01/31/%E5%81%8F%E5%AE%89%E4%B8%80%E9%9A%85/QQ20210131-3.jpg"><br><img src="/2021/01/31/%E5%81%8F%E5%AE%89%E4%B8%80%E9%9A%85/082.jpeg"></p>
<p>反正从我来到这个城市以后，没有再现过“苍穹之下”的天气了<br><img src="/2021/01/31/%E5%81%8F%E5%AE%89%E4%B8%80%E9%9A%85/QQ20210131-0.jpg"><br><img src="/2021/01/31/%E5%81%8F%E5%AE%89%E4%B8%80%E9%9A%85/QQ20210131-1.jpg"><br>写满了安静</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/01/31/Golang%E9%A1%B9%E7%9B%AE%E7%9A%84%E5%B8%B8%E7%94%A8%E5%BA%93/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Saifei Song">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="MoonlitAlley">
    </span>

    
    
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/01/31/Golang%E9%A1%B9%E7%9B%AE%E7%9A%84%E5%B8%B8%E7%94%A8%E5%BA%93/" class="post-title-link" itemprop="url">Golang项目的常用库</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2021-01-31 16:53:27" itemprop="dateCreated datePublished" datetime="2021-01-31T16:53:27+08:00">2021-01-31</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">Edited on</span>
        <time title="Modified: 2025-04-17 22:57:04" itemprop="dateModified" datetime="2025-04-17T22:57:04+08:00">2025-04-17</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Golang-module-%E6%94%B6%E9%9B%86/" itemprop="url" rel="index"><span itemprop="name">Golang module 收集</span></a>
        </span>
    </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/2021/01/31/Golang%E9%A1%B9%E7%9B%AE%E7%9A%84%E5%B8%B8%E7%94%A8%E5%BA%93/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2021/01/31/Golang%E9%A1%B9%E7%9B%AE%E7%9A%84%E5%B8%B8%E7%94%A8%E5%BA%93/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>[TOC]</p>
<h2 id="类型转化"><a href="#类型转化" class="headerlink" title="类型转化"></a>类型转化</h2><p><a target="_blank" rel="noopener" href="https://github.com/spf13/cast">spf13/cast</a></p>
<h4 id="官方说明"><a href="#官方说明" class="headerlink" title="官方说明"></a>官方说明</h4><blockquote>
<p>Easy and safe casting from one type to another in Go</p>
<blockquote>
<p>Cast is a library to convert between different go types in a consistent and easy way.</p>
</blockquote>
</blockquote>
<h4 id="使用示例"><a href="#使用示例" class="headerlink" title="使用示例"></a>使用示例</h4><p>Example ‘ToString’:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">cast.ToString(<span class="string">&quot;mayonegg&quot;</span>)         <span class="comment">// &quot;mayonegg&quot;</span></span><br><span class="line">cast.ToString(<span class="number">8</span>)                  <span class="comment">// &quot;8&quot;</span></span><br><span class="line">cast.ToString(<span class="number">8.31</span>)               <span class="comment">// &quot;8.31&quot;</span></span><br><span class="line">cast.ToString([]<span class="keyword">byte</span>(<span class="string">&quot;one time&quot;</span>)) <span class="comment">// &quot;one time&quot;</span></span><br><span class="line">cast.ToString(<span class="literal">nil</span>)                <span class="comment">// &quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> foo <span class="keyword">interface</span>&#123;&#125; = <span class="string">&quot;one more time&quot;</span></span><br><span class="line">cast.ToString(foo)                <span class="comment">// &quot;one more time&quot;</span></span><br></pre></td></tr></table></figure>
<p>当我们在项目（be-derive）中需要根据配置来决定返回值类型时，可以使用cast在最后阶段完成一个“统一的操作”</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(this *Derive)</span> <span class="title">formatCalcResult</span><span class="params">(val <span class="keyword">interface</span>&#123;&#125;, typeName <span class="keyword">string</span>)</span> <span class="title">interface</span></span>&#123;&#125; &#123;</span><br><span class="line">	<span class="keyword">switch</span> typeName &#123;</span><br><span class="line">	<span class="keyword">case</span> <span class="string">&quot;float&quot;</span>:</span><br><span class="line">		<span class="keyword">fallthrough</span></span><br><span class="line">	<span class="keyword">case</span> <span class="string">&quot;double&quot;</span>:</span><br><span class="line">		<span class="keyword">return</span> math.Trunc(cast.ToFloat64(val)*<span class="number">1e2</span>+<span class="number">0.5</span>) * <span class="number">1e-2</span></span><br><span class="line">	<span class="keyword">case</span> <span class="string">&quot;int&quot;</span>:</span><br><span class="line">		<span class="keyword">return</span> math.Trunc(cast.ToFloat64(val))</span><br><span class="line">	<span class="keyword">default</span>:</span><br><span class="line">		<span class="keyword">return</span> val</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="json处理"><a href="#json处理" class="headerlink" title="json处理"></a>json处理</h2><p><a target="_blank" rel="noopener" href="https://github.com/tidwall/gjson">tidwall/gjson</a><br><a target="_blank" rel="noopener" href="https://github.com/tidwall/sjson">tidwall/sjon</a></p>
<h4 id="官方说明-1"><a href="#官方说明-1" class="headerlink" title="官方说明"></a>官方说明</h4><blockquote>
<p> GJSON is a Go package that provides a fast and simple way to get values from a json document. It has features such as one line retrieval, dot notation paths, iteration, and parsing json lines.</p>
</blockquote>
<blockquote>
<p> SJSON is a Go package that provides a very fast and simple way to set a value in a json document. The purpose for this library is to provide efficient json updating for the SummitDB project. For quickly retrieving json values check out GJSON.</p>
</blockquote>
<h4 id="使用示例-1"><a href="#使用示例-1" class="headerlink" title="使用示例"></a>使用示例</h4><p>To unmarshal to a map[string]interface{}:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">m, ok :&#x3D; gjson.Parse(json).Value().(map[string]interface&#123;&#125;)</span><br><span class="line">if !ok &#123;</span><br><span class="line">	&#x2F;&#x2F; not a map</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Get a json value</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">if !gjson.Valid(json) &#123;</span><br><span class="line">	return errors.New(&quot;invalid json&quot;)</span><br><span class="line">&#125;</span><br><span class="line">value :&#x3D; gjson.Get(json, &quot;name.last&quot;)</span><br></pre></td></tr></table></figure>
<p>Set vlaue to a empty string or json string</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">value, _ :&#x3D; sjson.Set(&quot;&quot;, &quot;name.last&quot;, &quot;Anderson&quot;)</span><br><span class="line">println(value)</span><br><span class="line">&#x2F;&#x2F; Output:</span><br><span class="line">&#x2F;&#x2F; &#123;&quot;name&quot;:&#123;&quot;last&quot;:&quot;Anderson&quot;&#125;&#125;</span><br><span class="line"></span><br><span class="line">value, _ :&#x3D; sjson.Set(&#96;&#123;&quot;name&quot;:&#123;&quot;last&quot;:&quot;Anderson&quot;&#125;&#125;&#96;, &quot;name.first&quot;, &quot;Sara&quot;)</span><br><span class="line">println(value)</span><br><span class="line">&#x2F;&#x2F; Output:</span><br><span class="line">&#x2F;&#x2F; &#123;&quot;name&quot;:&#123;&quot;first&quot;:&quot;Sara&quot;,&quot;last&quot;:&quot;Anderson&quot;&#125;&#125;</span><br></pre></td></tr></table></figure>

<p>以下代码（arch-tool）的功能为：将kv为jsonpath类型的字符串，转化为标准的json格式<br>from <code>&#123;&quot;a.b.c&quot;:1, &quot;a.d&quot;:true&#125;</code> to <code>&#123;&quot;a&quot;:&#123;&quot;b&quot;:&#123;&quot;c&quot;:1&#125;, &quot;d&quot;:true&#125;&#125;</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">aeFeatures :&#x3D; make(map[string]interface&#123;&#125;)</span><br><span class="line">err :&#x3D; json.Unmarshal([]byte(gjson.Get(aeItemStr, &quot;features&quot;).Raw), &amp;aeFeatures)</span><br><span class="line">if err !&#x3D; nil &#123;</span><br><span class="line">	log.Println(fmt.Sprintf(&quot;json.Unmarshal aeItemStr features err&#x3D;%v&quot;, err))</span><br><span class="line">	continue</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">profileFeaturesStr :&#x3D; &#96;&#123; &#125;&#96;</span><br><span class="line">for featuresKey, featuresValue :&#x3D; range aeFeatures &#123;</span><br><span class="line">	profileFeaturesStr, _ &#x3D; sjson.Set(profileFeaturesStr, featuresKey, featuresValue)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="http请求"><a href="#http请求" class="headerlink" title="http请求"></a>http请求</h1><p><a target="_blank" rel="noopener" href="https://github.com/parnurzeal/gorequest">parnurzeal/gorequest</a></p>
<h4 id="官方说明-2"><a href="#官方说明-2" class="headerlink" title="官方说明"></a>官方说明</h4><blockquote>
<p>GoRequest – Simplified HTTP client ( inspired by famous SuperAgent lib in Node.js )</p>
<blockquote>
<p>GoRequest makes thing much more simple for you, making http client more awesome and fun like SuperAgent + golang style usage.</p>
</blockquote>
</blockquote>
<h4 id="使用示例-2"><a href="#使用示例-2" class="headerlink" title="使用示例"></a>使用示例</h4><p>Sth in oneline<br><code>resp, body, errs = gorequest.New().Timeout(time.Duration(inter.Timeout) * time.Millisecond).Proxy(&quot;http://proxy:999&quot;).Get(&quot;http://example-no-proxy.com&quot;).End()</code><br>Call Back:<br>Moreover, GoRequest also supports callback function. This gives you much more flexibility on using it. You can use it any way to match your own style! Let’s see a bit of callback example:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">func printStatus(resp gorequest.Response, body string, errs []error)&#123;</span><br><span class="line">  fmt.Println(resp.Status)</span><br><span class="line">&#125;</span><br><span class="line">gorequest.New().Get(&quot;http:&#x2F;&#x2F;example.com&quot;).End(printStatus)</span><br></pre></td></tr></table></figure>

<p>For a JSON POST with standard libraries, you might need to marshal map data structure to json format, set headers to ‘application/json’ (and other headers if you need to) and declare http.Client. So, your code becomes longer and harder to maintain:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">m :&#x3D; map[string]interface&#123;&#125;&#123;</span><br><span class="line">  &quot;name&quot;: &quot;backy&quot;,</span><br><span class="line">  &quot;species&quot;: &quot;dog&quot;,</span><br><span class="line">&#125;</span><br><span class="line">mJson, _ :&#x3D; json.Marshal(m)</span><br><span class="line">contentReader :&#x3D; bytes.NewReader(mJson)</span><br><span class="line">req, _ :&#x3D; http.NewRequest(&quot;POST&quot;, &quot;http:&#x2F;&#x2F;example.com&quot;, contentReader)</span><br><span class="line">req.Header.Set(&quot;Content-Type&quot;, &quot;application&#x2F;json&quot;)</span><br><span class="line">req.Header.Set(&quot;Notes&quot;,&quot;GoRequest is coming!&quot;)</span><br><span class="line">client :&#x3D; &amp;http.Client&#123;&#125;</span><br><span class="line">resp, _ :&#x3D; client.Do(req)</span><br></pre></td></tr></table></figure>

<p>摘取了项目（ext-profile）中的使用示例</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">request :&#x3D; gorequest.New().Timeout(time.Duration(inter.Timeout) * time.Millisecond)</span><br><span class="line">for key, value :&#x3D; range header &#123;</span><br><span class="line">	request.Header.Set(key, value)</span><br><span class="line">&#125;</span><br><span class="line">for i :&#x3D; inter.Retries; i &gt; 0; i-- &#123;</span><br><span class="line">	resp, result, errs :&#x3D; request.Post(inter.Url).Send(body).End()</span><br><span class="line">	if err :&#x3D; resp.Body.Close(); err!&#x3D; nil &#123;</span><br><span class="line">		ilog.LogReqErr(ilog.LL_ERROR, &quot;async&quot;, feature.RequestId, &quot;resp body close err&quot;, err)</span><br><span class="line">	&#125;</span><br><span class="line">	if errs !&#x3D; nil &#123;</span><br><span class="line">		&#x2F;&#x2F;TODO log</span><br><span class="line">		ilog.LogReqErr(ilog.LL_ERROR, &quot;async&quot;, feature.RequestId, &quot;get third party result fail&quot;, errs)</span><br><span class="line">		continue</span><br><span class="line">	&#125;</span><br><span class="line">	return &amp;resultItem&#123;result: result, identification: inter.UrlName&#125;, nil</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



      

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      const activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      const commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

    </div>
  </main>

  <footer class="footer">
    <div class="footer-inner">
      

      

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Saifei Song</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/pisces/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a>
  </div>

    </div>
  </footer>

  
  <script src="//cdn.jsdelivr.net/npm/animejs@3.2.0/lib/anime.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  




  <script src="/js/local-search.js"></script>















  








  

  
<script>
NexT.utils.loadComments('#valine-comments', () => {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/valine@1.4.14/dist/Valine.min.js', () => {
    new Valine(Object.assign({
      el  : '#valine-comments',
      path: "/",
    }, {"enable":true,"appId":"2hxowQ6pisGlXmzRuUTfpTil-gzGzoHsz","appKey":"ToGMLCAskP6uM4bS5pRgJII9","placeholder":"Just go go","avatar":"monsterid","meta":["nick","mail","link"],"pageSize":10,"lang":null,"visitor":false,"comment_count":true,"recordIP":false,"serverURLs":null,"enableQQ":false,"requiredFields":[]}
    ));
  }, window.Valine);
});
</script>

</body>
</html>
